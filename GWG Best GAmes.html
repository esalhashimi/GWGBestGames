<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أفضل العاب السنة لقناة GWG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .table-container {
            display: flex;
            gap: 1.5rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            max-width: 350px;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        thead {
            background-color: #4a5568;
            color: white;
        }
        th, td {
            padding: 0.75rem;
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        tbody tr:nth-child(odd) {
            background-color: #f7fafc;
        }
        tbody tr:nth-child(even) {
            background-color: #edf2f7;
        }
        .btn {
            padding: 0.75rem 2rem;
            font-weight: 700;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #4c51bf;
            color: white;
        }
        .btn-primary:hover {
            background-color: #3f45a8;
        }
        .btn-secondary {
            background-color: #2f855a;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #276749;
        }
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.75rem;
            text-align: center;
            width: 90%;
            max-width: 450px;
        }
        .duplicate-row {
            background-color: #fca5a5 !important;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Main Container -->
    <div class="container bg-white rounded-lg shadow-xl mt-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-2">لوحة نتائج الألعاب</h1>
            <p class="text-gray-500">قم بتحليل نتائج الألعاب من الجداول أدناه.</p>
        </header>

        <!-- Input Tables Section -->
        <div class="table-container mb-12">
            <!-- Table 1 -->
            <div class="flex flex-col items-center border border-gray-300 rounded-lg p-4 bg-gray-50">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">أفضل 10 ألعاب (جاسم)</h2>
                <table id="table1">
                    <thead>
                        <tr>
                            <th class="px-4 py-2">رقم تسلسلي</th>
                            <th class="px-4 py-2">اسم اللعبة</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be dynamically generated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Table 2 -->
            <div class="flex flex-col items-center border border-gray-300 rounded-lg p-4 bg-gray-50">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">أفضل 10 ألعاب (مشعل)</h2>
                <table id="table2">
                    <thead>
                        <tr>
                            <th class="px-4 py-2">رقم تسلسلي</th>
                            <th class="px-4 py-2">اسم اللعبة</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be dynamically generated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Table 3 -->
            <div class="flex flex-col items-center border border-gray-300 rounded-lg p-4 bg-gray-50">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">أفضل 10 ألعاب (إبراهيم)</h2>
                <table id="table3">
                    <thead>
                        <tr>
                            <th class="px-4 py-2">رقم تسلسلي</th>
                            <th class="px-4 py-2">اسم اللعبة</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be dynamically generated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Action Button -->
        <div class="flex justify-center mb-12">
            <button id="calculate-btn" class="btn btn-primary">حساب افضل 5 العاب لقنات GWG</button>
        </div>

        <!-- Results Table Section -->
        <section class="results-section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">جدول النتائج النهائية</h2>
            <table class="w-full max-w-lg mx-auto bg-white rounded-lg shadow-md">
                <thead>
                    <tr>
                        <th class="px-4 py-2">رقم تسلسلي</th>
                        <th class="px-4 py-2">اسم اللعبة</th>
                        <th class="px-4 py-2">مجموع النقاط</th>
                    </tr>
                </thead>
                <tbody id="results-table-body">
                    <!-- Results will be displayed here -->
                </tbody>
            </table>
            <div class="flex justify-center mt-6">
                <button id="export-btn" class="btn btn-secondary">تصدير إلى مذكرة</button>
            </div>
        </section>
    </div>

    <!-- Custom Modal for Messages -->
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <p id="modal-message" class="text-lg font-semibold text-gray-700 mb-4"></p>
            <button onclick="document.getElementById('message-modal').style.display='none'" class="btn btn-primary">حسناً</button>
        </div>
    </div>
    
    <!-- Welcome Modal -->
    <div id="welcome-modal" class="modal" style="display: flex;">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ملاحظة:</h2>
            <ul class="text-right list-disc list-inside mb-6 space-y-3 text-gray-600">
                <li>طريقة حساب افضل الألعاب بأستخدام خاصية النقاط.</li>
                <li>استخدم أزرار الأسهم <strong>(فوق / تحت)</strong> للتنقل داخل عناصر الجدول.</li>
                <li>استخدم زر <strong>Enter</strong> للتنقل بين الجداول.</li>
                <li>لايقبل اسماء العاب متشابه داخل نفس الجدول</li>
                <li>إذا هناك خانة لاتوجد لعبة يجب ترك الخانة فاضية</li>
                 <li>الحروف الصغيرة و الحروف الكبيرة لأسم العبة هي نفسها</li>
            </ul>
            <button id="welcome-continue-btn" class="btn btn-primary">متابعة</button>
        </div>
    </div>

    <script>
        // --- Welcome Modal Logic ---
        const welcomeModal = document.getElementById('welcome-modal');
        const welcomeContinueBtn = document.getElementById('welcome-continue-btn');

        // Add event listener to the continue button to hide the modal
        welcomeContinueBtn.addEventListener('click', () => {
            welcomeModal.style.display = 'none';
        });

        // Function to populate the tables with data (initially empty)
        function populateTables() {
            const tableIds = ["table1", "table2", "table3"];
            tableIds.forEach((tableId, index) => {
                const tbody = document.querySelector(`#${tableId} tbody`);
                tbody.innerHTML = ''; // Clear existing rows
                for (let i = 0; i < 10; i++) {
                    const row = tbody.insertRow();
                    const rankCell = row.insertCell();
                    const nameCell = row.insertCell();
                    rankCell.textContent = 10 - i; // Rank from 10 down to 1
                    // The input field starts empty
                    nameCell.innerHTML = `<input type="text" placeholder="أدخل اسم اللعبة" class="w-full bg-transparent text-center" data-table-id="${tableId}" data-row-index="${i}" />`;
                }
            });
        }

        // Function to show a custom modal message
        function showMessage(message) {
            document.getElementById('modal-message').textContent = message;
            document.getElementById('message-modal').style.display = 'flex';
        }

        // Function to normalize game names (trim spaces, remove extra spaces, lowercase)
        function normalizeName(name) {
            return name.trim().replace(/\s+/g, ' ').toLowerCase();
        }

        // Event listener for the "Calculate" button
        document.getElementById('calculate-btn').addEventListener('click', () => {
            // Clear any previous highlights
            document.querySelectorAll('.duplicate-row').forEach(row => row.classList.remove('duplicate-row'));

            const allGames = [];
            const tables = [
                document.getElementById('table1'),
                document.getElementById('table2'),
                document.getElementById('table3')
            ];

            // Step 1: Validate for unique names in each table and highlight duplicates
            const allNormalizedNames = new Map();
            let hasDuplicateInOneTable = false;

            tables.forEach(table => {
                const gameNameRowsInTable = new Map();
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const inputElement = row.cells[1].querySelector('input');
                    const name = inputElement.value;
                    inputElement.style.color = ''; // Reset input color
                    if (name.trim() !== '') {
                        const normalizedName = normalizeName(name);
                        if (gameNameRowsInTable.has(normalizedName)) {
                            hasDuplicateInOneTable = true;
                            // Highlight the current row and the previously found row
                            row.classList.add('duplicate-row');
                            gameNameRowsInTable.get(normalizedName).classList.add('duplicate-row');
                        } else {
                            gameNameRowsInTable.set(normalizedName, row);
                        }
                        
                        if (!allNormalizedNames.has(normalizedName)) {
                            allNormalizedNames.set(normalizedName, []);
                        }
                        allNormalizedNames.get(normalizedName).push(inputElement);
                    }
                });
            });

            if (hasDuplicateInOneTable) {
                showMessage("يجب أن تكون جميع أسماء الألعاب فريدة في كل جدول. تم تظليل الصفوف المكررة باللون الأحمر.");
                return; // Stop the calculation
            }
            
            // Highlight duplicates across tables
            allNormalizedNames.forEach(inputs => {
                if (inputs.length > 1) {
                    inputs.forEach(input => input.style.color = 'red');
                }
            });

            // Step 2: Collect all game data and calculate points
            tables.forEach(table => {
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const rank = parseInt(row.cells[0].textContent);
                    const name = row.cells[1].querySelector('input').value;
                    if (name.trim() !== '') {
                        const normalizedName = normalizeName(name);
                        // Points are now reversed: Rank 10 = 1 point, Rank 1 = 10 points
                        const points = 11 - rank; 
                        allGames.push({
                            originalName: name,
                            normalizedName: normalizedName,
                            points: points
                        });
                    }
                });
            });

            // Step 3: Aggregate points for each unique game
            const gameScores = {};
            
            allGames.forEach(game => {
                const { normalizedName, points } = game;
                if (!gameScores[normalizedName]) {
                    gameScores[normalizedName] = {
                        totalPoints: 0,
                        originalName: game.originalName,
                    };
                }
                gameScores[normalizedName].totalPoints += points;
            });

            // Step 4: Sort games by total points in descending order and get the top 5
            const sortedGames = Object.keys(gameScores).map(normalizedName => {
                return {
                    name: gameScores[normalizedName].originalName,
                    normalizedName: normalizedName,
                    totalPoints: gameScores[normalizedName].totalPoints
                };
            }).sort((a, b) => b.totalPoints - a.totalPoints).slice(0, 5);

            // Step 5: Display the results in the final table, reversed
            const resultsBody = document.getElementById('results-table-body');
            resultsBody.innerHTML = '';
            document.querySelector('.results-section').classList.remove('hidden');

            // Reverse the array to display from lowest score (rank 5) to highest score (rank 1)
            sortedGames.reverse();

            sortedGames.forEach((game, index) => {
                const row = resultsBody.insertRow();
                const rankCell = row.insertCell();
                const nameCell = row.insertCell();
                const pointsCell = row.insertCell();
                
                // Display rank from 5 down to 1
                rankCell.textContent = 5 - index;
                nameCell.textContent = game.name;
                pointsCell.textContent = game.totalPoints;
            });
        });

        // Function to export the final results table to a Note/Text file
        document.getElementById('export-btn').addEventListener('click', () => {
            const tablesToExport = [
                { id: 'table1', title: 'نتائج الجدول 1' },
                { id: 'table2', title: 'نتائج الجدول 2' },
                { id: 'table3', title: 'نتائج الجدول 3' },
            ];
            
            const finalResultsTable = document.getElementById('results-table-body');
            let content = "أفضل 5 ألعاب لقناة GWG\n\n";

            // Export final results first
            content += "### النتائج النهائية\n";
            content += "الترتيب,اسم اللعبة,مجموع النقاط\n";
            const finalRows = finalResultsTable.querySelectorAll('tr');
            finalRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = Array.from(cells).map(cell => `"${cell.textContent.trim()}"`).join(',');
                content += rowData + "\n";
            });


            tablesToExport.forEach(tableInfo => {
                const table = document.getElementById(tableInfo.id);
                if (!table) return;

                content += `\n\n### ${tableInfo.title}\n`; // Add title with markdown heading for clarity
                content += "الترتيب,اسم اللعبة\n";
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const rank = row.cells[0].textContent.trim();
                    const gameName = row.cells[1].querySelector('input').value.trim();
                    if (gameName) { // Only add rows that have a game name
                        content += `${rank},"${gameName}"\n`;
                    }
                });
            });

            const blob = new Blob([content], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "GWG_نتائج_الألعاب.txt");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        });

        // --- Keyboard Navigation Logic ---
        document.addEventListener('keydown', (e) => {
            const focusedInput = document.activeElement;
            if (focusedInput.tagName === 'INPUT') {
                const tableIds = ["table1", "table2", "table3"];
                const currentTableId = focusedInput.dataset.tableId;
                const currentRowIndex = parseInt(focusedInput.dataset.rowIndex);
                
                let newTargetInput = null;
                const totalRows = 10;
                
                const currentTableIndex = tableIds.indexOf(currentTableId);

                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        if (currentRowIndex < totalRows - 1) {
                            newTargetInput = document.querySelector(`#${currentTableId} tbody tr:nth-child(${currentRowIndex + 2}) input`);
                        }
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        if (currentRowIndex > 0) {
                            newTargetInput = document.querySelector(`#${currentTableId} tbody tr:nth-child(${currentRowIndex}) input`);
                        }
                        break;
                    case 'Enter':
                        e.preventDefault();
                        // New logic: Move horizontally to the same row in the next table
                        const nextTableIndex = (currentTableIndex + 1) % tableIds.length;
                        const nextTableId = tableIds[nextTableIndex];
                        
                        // currentRowIndex is 0-based, so nth-child is currentRowIndex + 1
                        const targetRowSelector = `tbody tr:nth-child(${currentRowIndex + 1}) input`;
                        
                        newTargetInput = document.querySelector(`#${nextTableId} ${targetRowSelector}`);
                        break;
                }

                if (newTargetInput) {
                    newTargetInput.focus();
                }
            }
        });

        // Initial population of the tables
        populateTables();
    </script>
</body>
</html>
